<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DirectSync Web Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.29/"></script>

    <style>
        .font-sans { font-family: 'Inter', sans-serif; }
    </style>
</head>

<body class="min-h-screen bg-gray-50 font-sans p-4 sm:p-8">

<div class="max-w-6xl mx-auto space-y-4">
    <header class="bg-white p-6 rounded-xl shadow-lg">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-900">DirectSync Web Editor</h1>
                <p class="text-sm text-gray-500">Map-first view for managing poles.</p>
            </div>
            <div class="flex gap-2 flex-wrap justify-end">
                <button id="my-location-btn" class="bg-white border border-blue-200 text-blue-700 hover:bg-blue-50 text-sm font-semibold py-2 px-3 rounded-lg shadow-sm">My Location</button>

                <button id="add-pole-btn" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2 px-3 rounded-lg shadow-md flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Add New Pole (GPS)
                </button>
            </div>
        </div>
    </header>

    <div class="bg-white p-6 rounded-xl shadow-lg space-y-4">
        <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
            <div class="flex items-center gap-2 flex-wrap">
                <label for="layer-select" class="text-sm font-semibold text-gray-700">Layer</label>
                <select id="layer-select" class="border border-gray-300 rounded-lg px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="transfer">Transfer</option>
                </select>
            </div>

            <div class="flex-1 flex flex-col gap-2 lg:flex-row lg:items-center lg:gap-3">
                <div class="flex flex-1 gap-2">
                    <input id="search-input" type="text" placeholder="Search by pole number or address" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    <button id="search-btn" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2 px-3 rounded-lg shadow-md">Search</button>
                </div>
                <p class="text-xs text-gray-500">Status colors: Ready (green), Blocked (red), Completed (yellow)</p>
            </div>
        </div>

        <div id="map-view" class="w-full h-[70vh] rounded-xl overflow-hidden border border-gray-200"></div>
    </div>
</div>

<script>
/* -----------------------------
   CONFIG
--------------------------------*/
const FEATURE_LAYER_URL =
    "https://services7.arcgis.com/NanlOhKb0A7a7kSU/arcgis/rest/services/Pole_Transfer_System__DEV__Transfers/FeatureServer/0";

const STATUS_FIELD_NAME = "Status";
const POLE_NUMBER_FIELD = "Old_Pole__";
const GEOCODER_URL = "https://geocode-api.arcgis.com/arcgis/rest/services/World/GeocodeServer";

/* -----------------------------
   OAUTH LOGIN FIRST
--------------------------------*/
require([
    "esri/identity/OAuthInfo",
    "esri/identity/IdentityManager"
], function (OAuthInfo, IdentityManager) {

    const info = new OAuthInfo({
        appId: "c6dKp7cbBFCn4m8k",
        portalUrl: "https://www.arcgis.com",
        popup: true
    });

    IdentityManager.registerOAuthInfos([info]);

    IdentityManager
        .checkSignInStatus(info.portalUrl + "/sharing")
        .catch(() => IdentityManager.getCredential(info.portalUrl + "/sharing"))
        .then(() => {
            console.log("OAuth login successful");
            initializeMap();   // <-- Load map AFTER login
        })
        .catch((err) => {
            alert("Login failed: " + err.message);
        });
});

/* -----------------------------
   MAP + FEATURELAYER
--------------------------------*/
function initializeMap() {

    require([
        "esri/config",
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/rest/support/Query",
        "esri/rest/locator",
        "esri/core/reactiveUtils"
    ], function (esriConfig, Map, MapView, FeatureLayer, Query, locator, reactiveUtils) {

        const statusRenderer = {
            type: "unique-value",
            field: STATUS_FIELD_NAME,
            defaultSymbol: { type: "simple-marker", color: "#6b7280", outline: { color: "#fff", width: 1 }},
            uniqueValueInfos: [
                { value: "Ready",     symbol: { type: "simple-marker", color: "#16a34a", outline: { color: "#fff", width: 1 }}},
                { value: "Blocked",   symbol: { type: "simple-marker", color: "#dc2626", outline: { color: "#fff", width: 1 }}},
                { value: "Completed", symbol: { type: "simple-marker", color: "#eab308", outline: { color: "#fff", width: 1 }}}
            ]
        };

        /* Map */
        const map = new Map({
            basemap: "streets-navigation-vector"
        });

        const view = new MapView({
            container: "map-view",
            map,
            center: [-68.5, 44.7],
            zoom: 11
        });

        /* Feature Layer */
        const activeLayer = new FeatureLayer({
            url: FEATURE_LAYER_URL,
            outFields: ["*"],
            renderer: statusRenderer,
            popupTemplate: {
                title: "{Town} - {Road}",
                content: popupContent,
                actions: [
                    { title: "Set Ready",     id: "set-ready",     className: "esri-icon-check-mark" },
                    { title: "Set Blocked",   id: "set-blocked",   className: "esri-icon-close" },
                    { title: "Set Completed", id: "set-completed", className: "esri-icon-checkbox-checked" }
                ]
            }
        });

        map.add(activeLayer);

        /* Popup Actions */
        reactiveUtils.when(
            () => view.popup.visible,
            () => {
                view.popup.on("trigger-action", (evt) => {
                    const feature = view.popup.selectedFeature;
                    if (!feature) return;

                    let newStatus = null;
                    if (evt.action.id === "set-ready") newStatus = "Ready";
                    if (evt.action.id === "set-blocked") newStatus = "Blocked";
                    if (evt.action.id === "set-completed") newStatus = "Completed";

                    if (newStatus) {
                        activeLayer.applyEdits({
                            updateFeatures: [{
                                attributes: {
                                    OBJECTID: feature.attributes.OBJECTID,
                                    Status: newStatus
                                }
                            }]
                        }).then(() => {
                            view.popup.close();
                            activeLayer.refresh();
                        });
                    }
                });
            }
        );
    });

}

/* -----------------------------
   POPUP CONTENT
--------------------------------*/
function popupContent(feature) {
    const a = feature.graphic.attributes;
    return `
        <div class="space-y-2 text-sm">
            <div class="font-semibold text-gray-900">${a.Town} - ${a.Road}</div>
            <div><strong>Status:</strong> ${a.Status}</div>
            <div><strong>Lat/Lon:</strong> ${a.Latitude}, ${a.Longitude}</div>
        </div>
    `;
}
</script>

</body>
</html>













