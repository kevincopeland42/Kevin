<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DirectSync Web Editor</title>

    <!-- Tailwind (fine for dev even if it warns) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ArcGIS -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.29/"></script>

    <style>
        .font-sans { font-family: 'Inter', sans-serif; }
    </style>
</head>

<body class="min-h-screen bg-gray-50 font-sans p-4 sm:p-8">

    <div class="max-w-6xl mx-auto space-y-4">
        <header class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                <div>
                    <h1 class="text-3xl font-extrabold text-gray-900">DirectSync Web Editor</h1>
                    <p class="text-sm text-gray-500">Map-first view for managing poles.</p>
                </div>

                <div class="flex gap-2 flex-wrap justify-end">
                    <button id="my-location-btn" class="bg-white border border-blue-200 text-blue-700 hover:bg-blue-50 text-sm font-semibold py-2 px-3 rounded-lg shadow-sm">My Location</button>

                    <button id="add-pole-btn" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2 px-3 rounded-lg shadow-md flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Add New Pole (GPS)
                    </button>
                </div>
            </div>
        </header>

        <div class="bg-white p-6 rounded-xl shadow-lg space-y-4">
            <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">

                <div class="flex items-center gap-2 flex-wrap">
                    <label class="text-sm font-semibold text-gray-700">Layer</label>
                    <select id="layer-select"
                       class="border border-gray-300 rounded-lg px-3 py-2 text-sm shadow-sm focus:ring-blue-500">
                        <option value="transfer">Transfer</option>
                        <option value="maintenance">Maintenance</option>
                    </select>
                </div>

                <div class="flex-1 flex flex-col gap-2 lg:flex-row lg:items-center lg:gap-3">
                    <div class="flex flex-1 gap-2">
                        <input id="search-input"
                            placeholder="Search by pole number or address"
                            class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm"
                        />
                        <button id="search-btn"
                            class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2 px-3 rounded-lg shadow-md">
                            Search
                        </button>
                    </div>
                </div>
            </div>

            <div id="map-view" class="w-full h-[70vh] rounded-xl border border-gray-200"></div>
        </div>
    </div>


    <!-- =============================== -->
    <!--           JAVASCRIPT            -->
    <!-- =============================== -->

    <script>
        const FEATURE_LAYER_URL =
            "https://services7.arcgis.com/NanlOhKb0A7a7kSU/arcgis/rest/services/Pole_Transfer_System__DEV__Transfers/FeatureServer/0";

        const MAINTENANCE_FEATURE_LAYER_URL = ""; // future

        const STATUS_FIELD_NAME = "Status";
        const POLE_NUMBER_FIELD = "PoleNumber";

        const GEOCODER_URL =
            "https://geocode-api.arcgis.com/arcgis/rest/services/World/GeocodeServer";

        const USER_TOKEN =
            "3NKHt6i2urmWtqOuugvr9aBZiqWTKRgialUU7P61D4FafvHXw6Tewdp9yw6xew8Rm1Rz_QQCPAUDVt8z9JVLQUL9IM_L3Dbhbsiu89Qs7ujU_j0IuQwNFK_M4MATx0jsR4XUcyTaXsCckKTBgFUE8jEYwjH9eaIhWMyI0bC_p8pkFu0QbHeywSrwMV8sHiXJAmbsGotoQbroSdfxIc27dYaPgwksY8MzKjTWAN0sYaO3tBpguWWlcRQsOrM0qdHFDPrsjvU-hi56JqxEaWbthUPrpFgThoLykQmjQ--z73ruTSO9fIOEY9BaIhwgKzHOZvMvC7CbdzOKxkJHvI3cAjqTe7BcFUEzjElObidSUyg."; // replace your hacked token

        let map, view, activeLayer;


        /* -----------------------------
           Message Box Helper
        ------------------------------ */
        const showMessageBox = (message) => {
            const dialog = document.createElement("div");
            dialog.className =
                "fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50";

            dialog.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                    <p class="mb-4 text-gray-800 whitespace-pre-wrap">${message}</p>
                    <button onclick="this.parentNode.parentNode.remove()"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Close
                    </button>
                </div>
            `;
            document.body.appendChild(dialog);
        };


        /* -----------------------------
           Initialize ArcGIS Map
        ------------------------------ */
        function initializeMap() {
            require(
                [
                    "esri/config",
                    "esri/Map",
                    "esri/views/MapView",
                    "esri/layers/FeatureLayer",
                    "esri/rest/support/Query",
                    "esri/rest/locator"
                ],
                function (esriConfig, Map, MapView, FeatureLayer, Query, locator) {

                    /* Inject token for ALL ArcGIS requests */
                    if (USER_TOKEN) {
                        esriConfig.request.interceptors.push({
                            urls: /(arcgis\.com|services7\.arcgis\.com|geocode-api\.arcgis\.com)/i,
                            before: (params) => {
                                params.requestOptions.query = params.requestOptions.query || {};
                                if (!params.requestOptions.query.token) {
                                    params.requestOptions.query.token = USER_TOKEN;
                                }
                            }
                        });
                    }

                    map = new Map({
                        basemap: "streets-navigation-vector"
                    });

                    view = new MapView({
                        container: "map-view",
                        map,
                        center: [-71.0589, 42.3601], // Boston default
                        zoom: 12
                    });

                    /* Load initial layer */
                    setActiveLayer("transfer", FeatureLayer, Query, locator);

                    /* ADD POPUP EVENT LISTENER THE RIGHT WAY */
                    view.when(() => {
                        view.popup.on("trigger-action", handlePopupAction);
                    });

                    /* UI Events */
                    document.getElementById("layer-select")
                        .addEventListener("change", (e) =>
                            setActiveLayer(e.target.value, FeatureLayer, Query, locator)
                        );

                    document.getElementById("my-location-btn")
                        .addEventListener("click", geolocate);

                    document.getElementById("add-pole-btn")
                        .addEventListener("click", () => addNewPole(locator));

                    document.getElementById("search-btn")
                        .addEventListener("click", () =>
                            runSearch(Query, locator)
                        );

                    document.getElementById("search-input")
                        .addEventListener("keydown", (e) => {
                            if (e.key === "Enter") runSearch(Query, locator);
                        });
                }
            );
        }


        /* -----------------------------
           SET ACTIVE LAYER
        ------------------------------ */
        function setActiveLayer(layerKey, FeatureLayer) {
            const url =
                layerKey === "maintenance"
                    ? MAINTENANCE_FEATURE_LAYER_URL
                    : FEATURE_LAYER_URL;

            if (!url) {
                showMessageBox("Maintenance layer URL not configured.");
                return;
            }

            if (activeLayer) {
                map.remove(activeLayer);
            }

            activeLayer = new FeatureLayer({
                url,
                outFields: ["*"],
                renderer: {
                    type: "unique-value",
                    field: STATUS_FIELD_NAME,
                    uniqueValueInfos: [
                        { value: "Ready", symbol: marker("#16a34a") },
                        { value: "Blocked", symbol: marker("#dc2626") },
                        { value: "Completed", symbol: marker("#eab308") }
                    ],
                    defaultSymbol: marker("#6b7280")
                },
                popupTemplate: {
                    title: "{Town} - {Road}",
                    content: popupContent,
                    actions: [
                        { title: "Set Ready", id: "set-ready", className: "esri-icon-check-mark" },
                        { title: "Set Blocked", id: "set-blocked", className: "esri-icon-close" },
                        { title: "Set Completed", id: "set-completed", className: "esri-icon-checkbox-checked" }
                    ]
                }
            });

            map.add(activeLayer);
        }


        /* -----------------------------
           POPUP CONTENT
        ------------------------------ */
        function popupContent(feature) {
            const a = feature.graphic.attributes;
            return `
                <div class="space-y-2 text-sm">
                    <div class="font-semibold text-gray-900">
                        ${(a.Town || "N/A")} - ${(a.Road || "N/A")}
                    </div>
                    <div><strong>Status:</strong> ${a[STATUS_FIELD_NAME]}</div>
                    <div><strong>Lat/Lon:</strong> ${a.Latitude}, ${a.Longitude}</div>
                    <p class="text-xs text-gray-500">Use actions below to update status.</p>
                </div>
            `;
        }


        /* -----------------------------
           MARKER SYMBOL HELPER
        ------------------------------ */
        function marker(color) {
            return {
                type: "simple-marker",
                color,
                outline: { color: "white", width: 1 }
            };
        }


        /* -----------------------------
           POPUP ACTION HANDLER
        ------------------------------ */
        function handlePopupAction(event) {
            const f = view.popup.selectedFeature;
            if (!f) return;

            const id = f.attributes.OBJECTID;
            if (!id) return;

            let newStatus = null;
            if (event.action.id === "set-ready") newStatus = "Ready";
            if (event.action.id === "set-blocked") newStatus = "Blocked";
            if (event.action.id === "set-completed") newStatus = "Completed";

            if (newStatus) {
                activeLayer.applyEdits({
                    updateFeatures: [{
                        attributes: {
                            OBJECTID: id,
                            [STATUS_FIELD_NAME]: newStatus
                        }
                    }]
                }).then(result => {
                    if (result.updateFeatureResults[0].success) {
                        showMessageBox(`Status updated to ${newStatus}`);
                        activeLayer.refresh();
                    } else {
                        showMessageBox("Edit failed: " + result.updateFeatureResults[0].error.description);
                    }
                });
            }
        }


        /* -----------------------------
           GEOLOCATE
        ------------------------------ */
        function geolocate() {
            if (!navigator.geolocation)
                return showMessageBox("Browser does not support geolocation.");

            navigator.geolocation.getCurrentPosition(
                pos => {
                    const { latitude, longitude } = pos.coords;
                    view.goTo({ center: [longitude, latitude], zoom: 15 });
                },
                err => showMessageBox("GPS Error: " + err.message)
            );
        }


        /* -----------------------------
           SEARCH
        ------------------------------ */
        function runSearch(Query, locator) {
            const text = document.getElementById("search-input").value.trim();
            if (!text) return;

            const numeric = /^\d+$/.test(text);

            if (numeric) {
                const q = new Query({
                    where: `${POLE_NUMBER_FIELD} = '${text}'`,
                    outFields: ["*"],
                    returnGeometry: true
                });

                activeLayer.queryFeatures(q).then(res => {
                    if (res.features.length === 0)
                        return showMessageBox("Pole not found.");

                    const f = res.features[0];
                    view.goTo({ target: f.geometry, zoom: 18 });
                    view.popup.open({ features: [f], location: f.geometry });
                });

            } else {
                locator.addressToLocations(GEOCODER_URL, {
                    address: { SingleLine: text },
                    maxLocations: 1
                }).then(res => {
                    if (res.length === 0)
                        return showMessageBox("Address not found.");

                    view.goTo({ target: res[0].location, zoom: 15 });
                });
            }
        }


        /* -----------------------------
           START THE MAP
        ------------------------------ */
        window.onload = initializeMap;

    </script>

</body>
</html>

</html>


